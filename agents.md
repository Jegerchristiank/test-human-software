Agentregler for holdbar, sikker og vedligeholdbar kode

Formål og prioritet. Du skal producere ændringer, der er driftssikre, auditerbare og nemme at videreudvikle. Prioritetsrækkefølgen er: datasikkerhed og korrekthed først, derefter bagudkompatibilitet, derefter performance, derefter udvikler-ergonomi. Hvis to krav kolliderer, skal du eksplicit forklare tradeoff og vælge den løsning, der minimerer risiko og fremtidig kompleksitet.

Arbejdsproces. Før du ændrer noget, skal du etablere kontekst ved at læse relevante filer og især docs/activity.md, hvis den findes. Du skal derefter formulere en kort todo-plan med afhængigheder og risici, samt eksplicitte acceptkriterier, der kan verificeres. Hvis kontekst eller krav er uklare, skal du spørge opfølgende, indtil acceptkriterierne er entydige, eller alternativt arbejde videre på en tydeligt markeret antagelse, der er minimal og reversibel.

Ændringsdisciplin. Du må ikke bryde eksisterende funktionalitet eller API-kontrakter uden at dokumentere det som breaking change og foreslå migrationsvej. Du skal foretrække små, isolerede commits/ændringer frem for brede refactors. Du må ikke introducere nye dependencies uden en kort begrundelse og en vurdering af vedligeholdelses- og supply-chain-risiko.

Sikkerhedskrav. Alle offentlige endpoints skal have rate limiting med både IP- og brugerbaseret dimension, sensible defaults og kontrolleret 429-adfærd. Al input fra klient, webhooks og tredjepart skal valideres skema-baseret med typechecks, længdegrænser, formatkrav og afvisning af ukendte felter. Authorization skal være eksplicit og ressourceorienteret, ikke implicit via UI. Secrets må aldrig hardcodes og må aldrig sendes til klienten; brug miljøvariabler, adskil environments og dokumentér rotation. Output encoding skal være kontekstafhængig: HTML-escaping ved HTML-rendering, URL-encoding ved query params, SQL-parameterisering altid, shell-escaping ved command execution og JSON-encoding ved serialization. Beskyt mod CSRF der hvor cookies/sessions bruges, og anvend restriktiv CORS. Tilføj relevante sikkerhedsheaders (som minimum CSP hvor realistisk, X-Content-Type-Options, Referrer-Policy og passende cookie-flags). Logning må ikke indeholde secrets eller følsomme persondata; anvend redaction og minimal nødvendig logning.

Specifikke integrationer i denne stack. Auth håndteres via Supabase Auth, men du skal stadig implementere server-side authorization checks på alle dataoperationer. Database er Supabase, og Row Level Security skal være udgangspunktet for databeskyttelse; enhver tabel med brugerdata skal have tydelige RLS-politikker og tests eller verifikationscases. Fil-lagring er Cloudflare R2; uploads skal være begrænsede (type/size), og adgang skal styres via signed URLs og passende TTL. Payments er Stripe; webhooks skal verificeres korrekt, idempotens skal håndteres, og alle betalingsrelaterede tilstandsskift skal være auditerbare. Emails er Resend; links og tokens i mails skal være tidsbegrænsede og sikre mod replay. Analytics er Plausible; undgå at sende personidentificerbare data.

Kvalitet og testbarhed. Kode skal være typesikker, deterministisk og have kontrolleret fejlbehandling. Enhver ny feature eller bugfix skal ledsages af passende tests på det relevante niveau, med fokus på de mest risikofyldte paths (auth, betaling, dataadgang, webhooks). Performanceoptimering må ikke ske på bekostning af klarhed og korrekthed uden dokumenteret behov.

UI-krav og selectors. Kravet om “unik id på alle divs” erstattes af et skalerbart selector-princip: alle elementer, der skal adresseres af automation eller agentstyring, skal have stabile, meningsfulde data-testid eller tilsvarende attributter. Unikke HTML id’er bruges kun, hvor semantisk nødvendigt. UI-komponenter skal være tilgængelige og konsistente med valgt komponentbibliotek; hold logik ude af præsentationskomponenter.

Dokumentation og aktivitetsspor. Hver gang du udfører projektrelaterede handlinger, skal du append’e en kort, faktuel post i docs/activity.md med dato, ændringsformål, berørte filer, udførte kommandoer, sikkerhedsimplikationer og eventuelle opfølgninger. Hvis du fraviger disse regler, skal du dokumentere hvorfor.

Kommunikation med mig. Før du beder mig om at gøre noget, du forudsætter jeg kan (adgang, credentials, domænebeslutninger, assets, scopes), skal du eksplicit fortælle, hvad der mangler, og hvorfor det er nødvendigt. Når du stiller opfølgende spørgsmål, skal de være målrettede mod at fastlåse acceptkriterier og kontekst, ikke generel smalltalk.
